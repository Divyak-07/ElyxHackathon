<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elyx Member Journey | Rohan Patel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Metrics Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Softer off-white background (slate-50) */
            color: #334155; /* Slate gray text */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .highlight-decision { transition: all 0.3s ease; box-shadow: 0 0 15px 2px rgba(79, 70, 229, 0.6); border: 1px solid rgba(79, 70, 229, 0.8); }
        .highlight-reason { transition: all 0.3s ease; box-shadow: 0 0 15px 2px rgba(5, 150, 105, 0.6); border: 1px solid rgba(5, 150, 105, 0.8); }
        .decision-bubble { cursor: pointer; border: 1px solid #6366f1; transition: background-color 0.2s ease-in-out; }
        .decision-bubble:hover { background-color: #4f46e5; color: white; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-content { animation: fadeIn 0.5s ease-out forwards; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem; border: 1px solid #d1d5db; width: 90%; max-width: 600px; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); }
        .modal-close { color: #9ca3af; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: #111827; text-decoration: none; }

        /* Chat Agent Styles */
        #chat-agent-window { display: none; position: absolute; bottom: 80px; right: 1.5rem; width: 350px; height: 450px; background-color: #ffffff; border: 1px solid #d1d5db; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); transition: all 0.3s ease; }
        
        /* Tab Navigation Styles */
        .nav-btn {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #e2e8f0;
            font-weight: 500;
        }
        .nav-btn.active {
            border-bottom-color: #ffffff;
            color: #ffffff;
            font-weight: 600;
        }
    </style>
</head>
<body class="antialiased">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-slate-800 p-4 shadow-md z-20">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white">Elyx Member Dashboard</h1>
                        <p class="text-sm text-slate-300">Rohan Patel</p>
                    </div>
                    <div id="api-status" class="hidden md:flex items-center space-x-2">
                        <span class="text-sm font-medium text-slate-300">API Status:</span>
                        <div id="api-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                    </div>
                    <div class="md:hidden">
                        <button id="menu-btn" class="text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                    </div>
                </div>
                <!-- Navigation Tabs -->
                <nav id="nav-menu" class="mt-4 hidden md:block">
                    <div class="flex flex-col md:flex-row md:space-x-2">
                        <button class="nav-btn active text-left" data-page="home">Home</button>
                        <button class="nav-btn text-left" data-page="journey">Journey</button>
                        <button class="nav-btn text-left" data-page="status">Health Status</button>
                        <button class="nav-btn text-left" data-page="profile">Profile</button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto">
            <!-- Home Page -->
            <main id="page-home" class="page-content p-4 md:p-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Welcome, Rohan!</h1>
                <p class="text-md md:text-lg text-slate-600 mt-1">This is your personalized health dashboard.</p>
                <div id="home-container" class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <!-- Home page cards will be injected here -->
                </div>
            </main>

            <!-- Journey Page -->
            <main id="page-journey" class="page-content hidden h-full flex flex-col md:flex-row">
                <aside id="timeline-sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-slate-200 overflow-y-auto p-6 hidden md:block">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Journey Timeline</h2>
                    <div id="timeline-container" class="relative border-l-2 border-slate-300 pl-6 space-y-8"></div>
                </aside>
                <section class="flex-1 flex flex-col bg-slate-100 relative">
                    <div class="border-b border-slate-200 p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <h2 id="conversation-title" class="text-lg font-semibold text-gray-900">Full Conversation</h2>
                            <div class="flex gap-2 md:hidden">
                                <button id="toggle-timeline-btn" class="bg-slate-200 text-slate-700 text-xs font-bold py-1 px-2 rounded">Timeline</button>
                                <button id="toggle-metrics-btn" class="bg-slate-200 text-slate-700 text-xs font-bold py-1 px-2 rounded">Metrics</button>
                            </div>
                        </div>
                        <div id="filter-container" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="conversation-container" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
                    <div class="p-4 border-t border-slate-200 bg-white/50">
                         <button id="chat-agent-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.839 8.839 0 01-4.082-.982L1 18l1.982-4.918A8.966 8.966 0 011 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.415 14.182A7.003 7.003 0 0010 15a7 7 0 100-14 7.003 7.003 0 00-5.585 2.818" clip-rule="evenodd" /></svg>
                            Ask Elyx AI
                        </button>
                    </div>
                    <div id="chat-agent-window" class="flex flex-col">
                        <div class="p-3 bg-gray-200 rounded-t-lg flex justify-between items-center">
                            <h3 class="text-md font-semibold text-gray-900">Elyx AI Assistant</h3>
                            <button id="chat-close-btn" class="text-gray-500 hover:text-gray-900 text-2xl font-bold">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-1 p-3 overflow-y-auto space-y-3 bg-white">
                            <div class="p-2 bg-indigo-100 rounded-lg text-sm text-indigo-800">Hi! Ask me why a decision was made. For example: "Why was the Whoop strap ordered?"</div>
                        </div>
                        <div class="p-3 border-t border-gray-200">
                            <form id="chat-form" class="flex gap-2">
                                <input type="text" id="chat-input" class="flex-1 bg-gray-200 text-gray-800 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ask a question...">
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 rounded-lg">Send</button>
                            </form>
                        </div>
                    </div>
                </section>
                <aside id="metrics-sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-white border-l border-slate-200 overflow-y-auto p-6 hidden md:block">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Internal Metrics</h2>
                    <div id="metrics-container" class="space-y-4"></div>
                </aside>
            </main>

            <!-- Health Status Page -->
            <main id="page-status" class="page-content hidden h-full p-4 md:p-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Health Status Dashboard</h2>
                <div id="health-status-container" class="space-y-8">
                    <!-- Health status content will be injected here -->
                </div>
            </main>

            <!-- Profile Page -->
            <main id="page-profile" class="page-content hidden h-full p-4 md:p-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Member Profile</h2>
                <div id="profile-container" class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </main>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="analysis-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'https://elyxhackathon.onrender.com';

        // --- DOM ELEMENT REFERENCES ---
        const apiIndicator = document.getElementById('api-indicator');
        const pages = {
            home: document.getElementById('page-home'),
            journey: document.getElementById('page-journey'),
            status: document.getElementById('page-status'),
            profile: document.getElementById('page-profile'),
        };
        const navButtons = document.querySelectorAll('.nav-btn');
        const menuBtn = document.getElementById('menu-btn');
        const navMenu = document.getElementById('nav-menu');
        
        // Journey Page Elements
        const timelineSidebar = document.getElementById('timeline-sidebar');
        const metricsSidebar = document.getElementById('metrics-sidebar');
        const toggleTimelineBtn = document.getElementById('toggle-timeline-btn');
        const toggleMetricsBtn = document.getElementById('toggle-metrics-btn');

        const homeContainer = document.getElementById('home-container');
        const timelineContainer = document.getElementById('timeline-container');
        const conversationContainer = document.getElementById('conversation-container');
        const metricsContainer = document.getElementById('metrics-container');
        const conversationTitle = document.getElementById('conversation-title');
        const filterContainer = document.getElementById('filter-container');
        const chatAgentBtn = document.getElementById('chat-agent-btn');
        const chatAgentWindow = document.getElementById('chat-agent-window');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const healthStatusContainer = document.getElementById('health-status-container');
        const profileContainer = document.getElementById('profile-container');
        const modal = document.getElementById('analysis-modal');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- STATE MANAGEMENT ---
        let allMessages = [];
        let metricsChart = null;
        let rhrChart = null;
        let hrvChart = null;
        let sentimentChart = null;

        // --- MAPPING & HELPERS ---
        const ROLE_ICONS = { 'Concierge': '📞', 'Medical Strategist': '🩺', 'Performance Scientist': '📊', 'Nutritionist': '🍎', 'Physiotherapist': '💪', 'Concierge Lead': '⭐', 'Member': '👤', 'Personal Assistant': '📋' };

        // --- API FUNCTIONS ---
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                if (apiIndicator.classList.contains('bg-yellow-500')) {
                    apiIndicator.classList.remove('bg-yellow-500', 'animate-pulse');
                    apiIndicator.classList.add('bg-green-500');
                }
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch from ${endpoint}:`, error);
                apiIndicator.classList.remove('bg-yellow-500', 'animate-pulse');
                apiIndicator.classList.add('bg-red-500');
                return null;
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderHomePage(messages) {
             homeContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Current Health Snapshot</h3>
                    <ul class="space-y-3 text-slate-600">
                        <li>HRV: <span class="font-bold text-green-600">65ms</span> (15%)</li>
                        <li>Resting HR: <span class="font-bold text-green-600">58bpm</span> (↓3bpm)</li>
                        <li>Glucose Avg: <span class="font-bold text-green-600">95mg/dL</span> (Stable)</li>
                    </ul>
                    <p class="text-sm text-slate-400 mt-4">Last updated: Aug 14, 2025</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Upcoming Activities</h3>
                    <ul class="space-y-3 text-slate-600">
                        <li>Aug 20: Strength Training Session (Rachel)</li>
                        <li>Aug 22: Water Quality Test (Ruby)</li>
                        <li>Sept 5: VO2 Max Test (Advik)</li>
                    </ul>
                     <p class="text-sm text-slate-400 mt-4">Stay on track with your personalized plan!</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow" id="weekly-report-card">
                     <h3 class="text-xl font-semibold text-slate-800 mb-2">Weekly Summary</h3>
                     <p class="text-sm text-slate-500 mb-4">Click to generate an AI-powered summary of the last week's progress and focus areas.</p>
                     <button id="generate-report-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">Generate Report</button>
                </div>
                <div data-page="journey" class="bg-white p-6 rounded-lg shadow-md lg:col-span-2 cursor-pointer hover:shadow-lg transition-shadow">
                     <h3 class="text-xl font-semibold text-slate-800 mb-2">Recent Communications</h3>
                     <p class="text-sm text-slate-500 mb-4">Click to view full journey</p>
                     <div id="recent-communications-container" class="space-y-4"></div>
                </div>
            `;
            renderRecentCommunications(messages);
        }

        function renderRecentCommunications(messages) {
            const recentMessages = messages.slice(-3);
            let commsHTML = '';
            recentMessages.forEach(msg => {
                const icon = ROLE_ICONS[msg.role] || '👤';
                commsHTML += `<div class="border-t border-slate-200 pt-3"><p class="text-sm font-semibold">${icon} ${msg.sender}</p><p class="text-sm text-slate-500 italic">"${msg.content.substring(0, 70)}..."</p></div>`;
            });
            document.getElementById('recent-communications-container').innerHTML = commsHTML;
        }
        
        function renderTimeline(milestones) {
            if (!milestones || milestones.length === 0) {
                timelineContainer.innerHTML = '<p class="text-red-500">Could not load timeline.</p>';
                return;
            }
            const milestonesByMonth = milestones.reduce((acc, msg) => {
                const month = new Date(msg.timestamp).toLocaleString('default', { month: 'long', year: 'numeric' });
                if (!acc[month]) acc[month] = [];
                acc[month].push(msg);
                return acc;
            }, {});
            let timelineHTML = '';
            for (const month in milestonesByMonth) {
                timelineHTML += `<button class="month-title text-md font-semibold text-indigo-600 -ml-1 mb-4 hover:underline" data-month-name="${month}">${month}</button>`;
                milestonesByMonth[month].forEach(milestone => {
                    const date = new Date(milestone.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    timelineHTML += `<div class="mb-8"><div class="absolute w-4 h-4 bg-indigo-500 rounded-full -left-2 border-2 border-white"></div><p class="text-sm text-gray-500">${date}</p><p class="font-medium text-gray-800">${milestone.content}</p></div>`;
                });
            }
            timelineContainer.innerHTML = timelineHTML;
        }

        function renderConversation(messages, filterRole = null) {
            const container = conversationContainer;
            if (!messages || !container) return;
            const filteredMessages = filterRole ? messages.filter(msg => msg.role === filterRole || msg.role === 'Member') : messages;
            conversationTitle.textContent = filterRole ? `Conversation with ${filterRole}` : 'Full Conversation';
            let conversationHTML = '';
            let lastDate = null;
            filteredMessages.forEach(msg => {
                const msgDate = new Date(msg.timestamp).toLocaleDateString();
                if (msgDate !== lastDate) {
                    conversationHTML += `<div class="text-center my-4"><span class="bg-slate-200 text-slate-600 text-xs font-medium px-3 py-1 rounded-full">${new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span></div>`;
                    lastDate = msgDate;
                }
                const isMember = msg.role === 'Member';
                const alignment = isMember ? 'justify-end' : 'justify-start';
                const bgColor = isMember ? 'bg-blue-600 text-white' : 'bg-white text-gray-800';
                const senderName = isMember ? 'You (Rohan Patel)' : `${msg.sender} (${msg.role})`;
                const icon = ROLE_ICONS[msg.role] || '👤';
                const isDecision = msg.tags.type === 'decision';
                const extraBubbleClasses = isDecision ? 'decision-bubble' : '';
                const decisionIndicatorHTML = isDecision ? `<p class="text-xs ${isMember ? 'text-indigo-200' : 'text-indigo-500'} mt-2 font-semibold border-t border-indigo-400/50 pt-1">💡 Click to see why</p>` : '';
                conversationHTML += `<div class="flex ${alignment} message-bubble" data-message-id="${msg.id}" data-message-type="${msg.tags.type || ''}"><div class="max-w-md lg:max-w-lg px-4 py-2 rounded-lg shadow-md ${bgColor} ${extraBubbleClasses}"><p class="text-sm font-bold mb-1">${icon} ${senderName}</p><p class="text-sm">${msg.content.replace(/\n/g, '<br>')}</p><p class="text-xs ${isMember ? 'text-blue-200' : 'text-gray-500'} text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>${decisionIndicatorHTML}</div></div>`;
            });
            container.innerHTML = conversationHTML || '<p class="text-center text-gray-500">No messages match this filter.</p>';
        }

        function renderMetrics(metrics) {
            if (!metrics) {
                metricsContainer.innerHTML = '<p class="text-red-500">Could not load metrics.</p>';
                return;
            }
            metricsContainer.innerHTML = `<div class="bg-white p-4 rounded-lg shadow"><p class="text-gray-500 text-sm">Total Elyx Team Interactions</p><p class="text-2xl font-bold text-gray-900">${metrics.total_elyx_team_interactions}</p></div><div class="bg-white p-4 rounded-lg shadow"><p class="text-gray-500 text-sm mb-2">Interactions by Role</p><canvas id="metricsChart"></canvas></div>`;
            renderMetricsChart(metrics.interactions_by_role);
        }

        function renderMetricsChart(data) {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            if (metricsChart) metricsChart.destroy();
            metricsChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(data), datasets: [{ label: 'Interactions', data: Object.values(data), backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] },
                options: { indexAxis: 'y', scales: { x: { ticks: { color: '#374151' } }, y: { ticks: { color: '#374151' } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderFilterControls(messages) {
            const roles = [...new Set(messages.filter(m => m.role !== 'Member' && m.role !== 'Personal Assistant').map(m => m.role))];
            let filterHTML = '<button class="filter-btn active px-3 py-1 text-sm font-medium rounded-full bg-indigo-600 text-white" data-role="all">All</button>';
            roles.forEach(role => {
                filterHTML += `<button class="filter-btn px-3 py-1 text-sm font-medium rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300" data-role="${role}">${ROLE_ICONS[role]} ${role}</button>`;
            });
            filterContainer.innerHTML = filterHTML;
        }

        function renderHealthStatus(messages, sentimentData) {
            const apoBMessage = messages.find(m => m.content.includes("Your ApoB is"));
            const apoBValue = apoBMessage ? apoBMessage.content.match(/ApoB is (\d+)/)[1] : 'N/A';
            
            let healthHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-900">Key Biomarker: ApoB</h3>
                        <p class="text-4xl font-bold text-indigo-600 mt-2">${apoBValue} <span class="text-lg font-medium text-gray-500">mg/dL</span></p>
                        <p class="text-sm text-gray-500 mt-2">Last measured: March 2025. This is a primary focus for long-term risk reduction.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-900">Member Satisfaction Trend</h3>
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
            `;
            healthStatusContainer.innerHTML = healthHTML;
            renderSentimentChart(sentimentData);
        }
        
        function renderSentimentChart(data) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            if (sentimentChart) sentimentChart.destroy();
            sentimentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month.split(' ')[0]),
                    datasets: [{
                        label: 'Avg Sentiment Score',
                        data: data.map(d => d.score),
                        borderColor: 'rgba(22, 163, 74, 1)',
                        backgroundColor: 'rgba(22, 163, 74, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { scales: { x: { ticks: { color: '#374151' } }, y: { ticks: { color: '#374151', min: -1, max: 1 } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderProfilePage() {
            const profileData = { "Name": "Rohan Patel", "Born": "12 March 1979 (Age 46)", "Occupation": "Regional Head of Sales, FinTech", "Residence": "Singapore", "Travel Hubs": "UK, US, South Korea, Jakarta", "Goal 1": "Reduce risk of heart disease by Dec 2026.", "Goal 2": "Enhance cognitive function by June 2026.", "Goal 3": "Implement annual full-body health screenings.", "Motivations": "Family history of heart disease; sustain career performance; be present for his young children.", "Personality": "Analytical, driven, values efficiency and evidence-based approaches.", "Wearables": "Garmin watch (used for runs), considering Oura ring." };
            let profileHTML = '';
            for(const [key, value] of Object.entries(profileData)) {
                profileHTML += `<div><p class="text-sm text-gray-500">${key}</p><p class="font-semibold text-gray-900">${value}</p></div>`;
            }
            profileContainer.innerHTML = profileHTML;
        }

        function renderAnalysisModal(title, content) {
            modalBody.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-900 mb-4">${title}</h2>
                <div class="space-y-4 text-gray-600">${content}</div>
            `;
        }

        function highlightTrace(traceData) {
            document.querySelectorAll('.highlight-decision, .highlight-reason').forEach(el => el.classList.remove('highlight-decision', 'highlight-reason'));
            if (!traceData) return;
            const decisionEl = document.querySelector(`[data-message-id='${traceData.decision.id}'] > div`);
            if (decisionEl) {
                decisionEl.classList.add('highlight-decision');
                decisionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            traceData.reasons.forEach(reason => {
                const reasonEl = document.querySelector(`[data-message-id='${reason.id}'] > div`);
                if (reasonEl) reasonEl.classList.add('highlight-reason');
            })
        }

        // --- CHAT AGENT LOGIC (SIMULATED) ---
        function findDecisionAndReasons(query) {
            const keywords = query.toLowerCase().match(/\b(\w+)\b/g) || [];
            const decisions = allMessages.filter(m => m.tags.type === 'decision');
            let bestMatch = null;
            let maxScore = 0;
            decisions.forEach(decision => {
                let score = 0;
                keywords.forEach(keyword => {
                    if (decision.content.toLowerCase().includes(keyword)) score++;
                });
                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = decision;
                }
            });
            if (bestMatch) {
                const reasons = allMessages.filter(m => m.tags.type === 'reason' && m.tags.linked_id === bestMatch.id);
                return { decision: bestMatch, reasons };
            }
            return null;
        }

        function addChatMessage(message, isUser = false) {
            const bgColor = isUser ? 'bg-blue-600 text-white' : 'bg-indigo-100 text-indigo-800';
            const messageEl = document.createElement('div');
            messageEl.className = `p-2 ${bgColor} rounded-lg text-sm`;
            messageEl.innerHTML = message;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- EVENT HANDLERS ---
        function handleNavClick(event) {
            const page = event.target.dataset.page;
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            if (pages[page]) pages[page].classList.remove('hidden');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === page) btn.classList.add('active');
            });
        }

        async function handleConversationClick(event) {
            const messageElement = event.target.closest('[data-message-id]');
            if (!messageElement) return;
            const messageType = messageElement.dataset.messageType;
            const messageId = messageElement.dataset.messageId;
            if (messageType === 'decision') {
                const traceData = await fetchData(`/messages/decision/${messageId}`);
                highlightTrace(traceData);
            } else {
                highlightTrace(null);
            }
        }

        function handleFilterClick(event) {
            if (!event.target.classList.contains('filter-btn')) return;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const clickedBtn = event.target;
            clickedBtn.classList.add('active', 'bg-indigo-600', 'text-white');
            clickedBtn.classList.remove('bg-gray-200', 'text-gray-700');
            const role = clickedBtn.dataset.role;
            renderConversation(allMessages, role === 'all' ? null : role);
        }

        async function handleTimelineClick(event) {
            if (!event.target.classList.contains('month-title')) return;
            const monthName = event.target.dataset.monthName;
            modalBody.innerHTML = '<p>Generating AI analysis...</p>';
            modal.style.display = 'block';
            const analysisData = await fetchData(`/episodes/${encodeURIComponent(monthName)}`);
            const analysisHTML = `
                <div class="space-y-4 text-gray-600">
                    <div><h3 class="font-semibold text-indigo-600">Primary Goal / Trigger</h3><p>${analysisData.primary_goal_trigger}</p></div>
                    <div><h3 class="font-semibold text-indigo-600">Friction Points</h3><ul class="list-disc list-inside">${analysisData.friction_points.map(fp => `<li>${fp}</li>`).join('')}</ul></div>
                    <div><h3 class="font-semibold text-indigo-600">Final Outcome</h3><p>${analysisData.final_outcome}</p></div>
                    <div>
                        <h3 class="font-semibold text-indigo-600 mb-2">Stateful Persona Analysis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-100 p-3 rounded-lg"><h4 class="font-semibold text-green-600">Before State</h4><p class="text-sm">${analysisData.persona_analysis.before}</p></div>
                            <div class="bg-gray-100 p-3 rounded-lg"><h4 class="font-semibold text-green-600">After State</h4><p class="text-sm">${analysisData.persona_analysis.after}</p></div>
                        </div>
                    </div>
                </div>
            `;
            renderAnalysisModal(`Episode Analysis: ${analysisData.month_name}`, analysisHTML);
        }
        
        async function handleReportGeneration() {
            modalBody.innerHTML = '<p>Generating AI weekly summary...</p>';
            modal.style.display = 'block';
            const reportData = await fetchData(`/reports/weekly`);
            renderAnalysisModal(`Weekly Report: ${reportData.week_of}`, reportData.summary);
        }

        function handleChatSubmit(event) {
            event.preventDefault();
            const query = chatInput.value.trim();
            if (!query) return;
            addChatMessage(query, true);
            chatInput.value = '';
            const result = findDecisionAndReasons(query);
            if (result && result.reasons.length > 0) {
                let response = `The decision to "${result.decision.content.substring(0, 50)}..." was made for the following reasons:<ul class="list-disc list-inside mt-2">`;
                result.reasons.forEach(reason => {
                    response += `<li>${reason.content}</li>`;
                });
                response += '</ul>';
                addChatMessage(response);
                highlightTrace(result);
            } else {
                addChatMessage("I couldn't find a specific reason for that decision in the log. Please try rephrasing your question or check the conversation manually.");
            }
        }
        
        function handleHomePageCardClick(event) {
            const card = event.target.closest('[data-page="journey"]');
            if (!card) return;
            const journeyNavButton = document.querySelector('.nav-btn[data-page="journey"]');
            if (journeyNavButton) {
                journeyNavButton.click();
            }
        }

        // --- INITIALIZATION ---
        async function initializeApp() {
            const [timelineData, allMessagesData, metricsData, sentimentData] = await Promise.all([
                fetchData('/messages/timeline'),
                fetchData('/messages'),
                fetchData('/metrics/internal'),
                fetchData('/metrics/sentiment')
            ]);
            allMessages = allMessagesData || [];

            // Render all components for all pages
            renderHomePage(allMessages);
            renderTimeline(timelineData);
            renderConversation(allMessages);
            renderMetrics(metricsData);
            renderFilterControls(allMessages);
            renderHealthStatus(allMessages, sentimentData);
            renderProfilePage();

            navButtons.forEach(btn => btn.addEventListener('click', handleNavClick));
            homeContainer.addEventListener('click', handleHomePageCardClick);
            homeContainer.addEventListener('click', (event) => {
                if(event.target.closest('#weekly-report-card')) {
                    handleReportGeneration();
                }
            });
            conversationContainer.addEventListener('click', handleConversationClick);
            filterContainer.addEventListener('click', handleFilterClick);
            timelineContainer.addEventListener('click', handleTimelineClick);
            chatAgentBtn.addEventListener('click', () => { chatAgentWindow.style.display = 'flex'; });
            chatCloseBtn.addEventListener('click', () => { chatAgentWindow.style.display = 'none'; });
            chatForm.addEventListener('submit', handleChatSubmit);
            
            // Responsive Menu Toggle
            menuBtn.addEventListener('click', () => {
                navMenu.classList.toggle('hidden');
            });
            
            // Responsive Sidebar Toggles
            toggleTimelineBtn.addEventListener('click', () => {
                timelineSidebar.classList.toggle('hidden');
                metricsSidebar.classList.add('hidden'); // Hide other sidebar
            });
            toggleMetricsBtn.addEventListener('click', () => {
                metricsSidebar.classList.toggle('hidden');
                timelineSidebar.classList.add('hidden'); // Hide other sidebar
            });

            modalCloseBtn.onclick = () => { modal.style.display = "none"; };
            window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>